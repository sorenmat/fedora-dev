FROM registry.fedoraproject.org/fedora-toolbox:latest

LABEL com.github.containers.toolbox="true" \
      usage="This image is meant to be used with the toolbox or distrobox command" \
      summary="A cloud-native terminal experience" \
      maintainer="jorge.castro@gmail.com"

COPY extra-packages /
RUN dnf update -y
RUN grep -v '^#' /extra-packages | xargs dnf install -y
RUN rm /extra-packages

# Install from testing
#RUN apk add hub --repository=http://dl-cdn.alpinelinux.org/alpine/edge/testing/
#RUN apk add kubectl --repository=http://dl-cdn.alpinelinux.org/alpine/edge/testing/

# Install gcloud

ENV CLOUD_SDK_VERSION=427.0.0
ENV PATH /google-cloud-sdk/bin:$PATH
RUN wget https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-${CLOUD_SDK_VERSION}-linux-x86_64.tar.gz && \
    tar xzf google-cloud-sdk-${CLOUD_SDK_VERSION}-linux-x86_64.tar.gz && \
    rm google-cloud-sdk-${CLOUD_SDK_VERSION}-linux-x86_64.tar.gz && \
    ln -s /lib /lib64 && \
    gcloud config set core/disable_usage_reporting true && \
    gcloud --version
RUN gcloud components install gke-gcloud-auth-plugin
#
# Install Eclipse JDK
#

ENV JAVA_HOME /opt/java/openjdk
ENV PATH $JAVA_HOME/bin:$PATH

# Default to UTF-8 file.encoding
ENV LANG='en_US.UTF-8' LANGUAGE='en_US:en' LC_ALL='en_US.UTF-8'

# fontconfig and ttf-dejavu added to support serverside image generation by Java programs
#RUN apk add --no-cache fontconfig libretls musl-locales musl-locales-lang ttf-dejavu tzdata zlib \
#    && rm -rf /var/cache/apk/*
#
#ENV JAVA_VERSION jdk-19.0.2+7
#
#RUN set -eux; \
#    ARCH="$(apk --print-arch)"; \
#    case "${ARCH}" in \
#       amd64|x86_64) \
#         ESUM='e2d971400ad2db25ad43ea6fa2058b269c0236e3977986dcdee2097da301beb2'; \
#         BINARY_URL='https://github.com/adoptium/temurin19-binaries/releases/download/jdk-19.0.2%2B7/OpenJDK19U-jdk_x64_alpine-linux_hotspot_19.0.2_7.tar.gz'; \
#         ;; \
#       *) \
#         echo "Unsupported arch: ${ARCH}"; \
#         exit 1; \
#         ;; \
#    esac; \
#	  wget -O /tmp/openjdk.tar.gz ${BINARY_URL}; \
#	  echo "${ESUM} */tmp/openjdk.tar.gz" | sha256sum -c -; \
#	  mkdir -p "$JAVA_HOME"; \
#	  tar --extract \
#	      --file /tmp/openjdk.tar.gz \
#	      --directory "$JAVA_HOME" \
#	      --strip-components 1 \
#	      --no-same-owner \
#	  ; \
#    rm -f /tmp/openjdk.tar.gz ${JAVA_HOME}/src.zip;
#
#RUN echo Verifying install ... \
#    && fileEncoding="$(echo 'System.out.println(System.getProperty("file.encoding"))' | jshell -s -)"; [ "$fileEncoding" = 'UTF-8' ]; rm -rf ~/.java \
#    && echo javac --version && javac --version \
#    && echo java --version && java --version \
#    && echo Complete.
#    

RUN   ln -fs /bin/sh /usr/bin/sh && \
      ln -fs /usr/bin/distrobox-host-exec /usr/local/bin/docker && \
      ln -fs /usr/bin/distrobox-host-exec /usr/local/bin/firefox && \
      ln -fs /usr/bin/distrobox-host-exec /usr/local/bin/flatpak && \ 
      ln -fs /usr/bin/distrobox-host-exec /usr/local/bin/podman && \
      ln -fs /usr/bin/distrobox-host-exec /usr/local/bin/rpm-ostree && \
      ln -fs /usr/bin/distrobox-host-exec /usr/local/bin/transactional-update
     
ENTRYPOINT /bin/zsh
